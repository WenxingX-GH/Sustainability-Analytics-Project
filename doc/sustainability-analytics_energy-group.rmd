
---
title: ""Report for Sustainability Analytics: Energy Recommendations 
based on weather data"
author: "Barbara Maier, Wenxing Xu, Güney Usta"
date: "2025-09-05"
output: 
  html_document: 
    toc: true
    toc_float: true
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,       # Show R code in the output document
  warning = FALSE,  # Suppress warnings in the output document
  message = FALSE,  # Suppress messages in the output document
  fig.width = 8,    # Width of figures in inches    
  fig.height = 5    # Height of figures in inches
  )
```

------------------------------------------------------------------------

```{r load-packages}
# Load necessary packages
library(dplyr)    # Data manipulation
library(ggplot2)  # Data visualization  
library(readr)    # Reading CSV files
library(tidyverse)
library(lubridate)
library(janitor)
```

------------------------------------------------------------------------

# Introduction

The transition to renewable energy sources presents both opportunities and 
challenges for individual homeowners. While technologies like photovoltaic (PV) 
systems and electric vehicles (EVs) are becoming more common, optimizing their 
use requires a deeper understanding of energy consumption patterns. 
The intermittent nature of solar energy, heavily influenced by local weather 
conditions, adds a layer of complexity to managing home energy efficiently.

This analysis addresses this challenge by examining historical energy data 
from a residential building equipped with a PV system and an EV. By correlating
the household's energy consumption data with local weather patterns, we seek to 
identify key relationships and trends. The ultimate goal is to develop 
data-driven recommendations that provide the homeowner with simple, 
effective advice to increase their self-consumption of clean energy. 
This will help in reducing energy costs and contributing to a more 
sustainable energy system.

# Datasets & Datasources

This analysis utilizes two primary data sources:

1. AEW Energie AG: Provides detailed energy production and consumption data 
for the household.
  - PV_Production_kWh: Photovoltaic energy production.
  - Consumption_Base_Load_kWh: Base load energy consumption.
  - Consumption_Heat_Pump_kWh: Energy consumed by the heat pump.
  - Consumption_EV_Charging_kWh: Energy used for charging an electric vehicle.
  - Consumption_Cooking_Lighting_etc_kWh: Energy for cooking, lighting, and 
  other appliances.
  - Consumption_Total_kWh: Total household energy consumption.
  - Self_Consumption_PV_kWh: Portion of PV production consumed directly.
  - Grid_Feed_In_PV_kWh: Surplus PV energy fed back into the grid.
  - Grid_Import_Total_kWh: Total energy imported from the grid.

2. MeteoSwiss: Provides local weather data.
- wind_speed_10m_mean: Mean wind speed at 10 meters.
- temperature_2m_mean: Mean air temperature at 2 meters.
- relative_humidity_2m_mean_from_hourly: Mean relative humidity at 2 meters.

# Data wrangling

## Function to load and process the AEW energy data

```{r}
load_and_process_energy_data <- function(file_path) {
  # Read the raw data which is in a long format
  energy_long <- read_csv(file_path)
  
  # Pivot the data from long to wide format
  # This creates a separate column for each unique "Metric"
  energy_wide <- energy_long %>%
    pivot_wider(
      names_from  = Metric,
      values_from = Value,
      values_fn   = ~ mean(.x, na.rm = TRUE),   # aggregate duplicates
      values_fill = NA_real_
    ) %>%
    janitor::clean_names() %>%
    mutate(
      timestamp = as_datetime(timestamp),
      date = as_date(timestamp)
    )

  return(energy_wide)
}
```


```{r}

energy_file <- "./data/household_energy_profile_Wynemattestrasse_17_5_years.csv"
energy_df <- read_csv(energy_file)
head(energy_df,100) 

```


```{r}

## Execute the functions to get processed data frames

energy_df <- load_and_process_energy_data(energy_file)

# Display the first few rows of the final merged dataset to verify
head(energy_df, 100)
```

```{r}
metroswiss_file_d <- "./data/ogd-smn_bus_d_historical.csv"
metroswiss_file_h <- "./data/ogd-smn_bus_h_historical_2020-2029.csv"
df_metroswiss_d <- read_csv(metroswiss_file_d)
df_metroswiss_h <- read_csv(metroswiss_file_h)
head(df_metroswiss_d,10) 
head(df_metroswiss_h,10)
str(df_metroswiss_d,10)
str(df_metroswiss_h,10)
```


## Function to load and process the MeteoSwiss weather data

```{r}
  # @WX: file for weather data? 
  
load_and_process_weather_data <- function(file_path_weatherdata) {
  # Read the raw weather data
  weather_raw <- read_delim(file_path_weatherdata, delim = ";")
  
  # Clean up the weather data
  weather_clean <- weather_raw %>%
    # Select only the relevant columns
    select(station_abbr, 
           reference_timestamp, 
           tre200h0,    # daily temperature
           ure200h0,    # humidity
           fkl010h0     # wind speed
           ) %>%
    # Rename columns for clarity and consistency
    rename(
      station = station_abbr,
      timestamp_str = reference_timestamp,
      `temperature_hourly/°C` = tre200h0,
      `humidity/%` = ure200h0,
      `wind_speed/m/s` = fkl010h0
    ) %>%
    # Convert the timestamp string to actual date objects
    mutate(date = dmy_hm(timestamp_str) %>% as_date()) %>%
    # Filter for the relevant date range (2020 onwards)
    filter(date >= as_date("2020-01-01"))
  
  return(weather_clean)
}

```


```{r}
# set working directory
setwd("C:/Users/xwxba/Documents/DataSc/Sustainability-Analytics/Sustainability-Analytics-Project")

## Define file paths 

energy_file <- "./data/household_energy_profile_Wynemattestrasse_17_5_years.csv"
weather_file <- "./data/ogd-smn_bus_h_historical_2020-2029.csv"

## Execute the functions to get processed data frames

energy_df <- load_and_process_energy_data(energy_file)
weather_df <- load_and_process_weather_data(weather_file)

# Merge the energy and weather dataframes using the 'date' column
# A left_join keeps all rows from the energy data and adds matching weather data
final_df_h <- left_join(energy_df, weather_df, by = "date")

# Display the first few rows of the final merged dataset to verify
head(final_df_h, 100)


```

```{r}
# Save the final merged dataset to a CSV file
readr::write_csv(final_df_h, "final_df_h.csv")
```

```{r}
str(final_df_h)
```


# Exploratory Data Analysis (EDA)

TODO: Add EDA content here.

```{r}

# compute daily means for weather + daily sums for energy

final_df_d <- final_df_h %>%
  group_by(date) %>%
  summarise(
    # Energy (sum over 24 hours per day)
    pv_production_k_wh              = sum(pv_production_k_wh, na.rm = TRUE),
    consumption_base_load_k_wh      = sum(consumption_base_load_k_wh, na.rm = TRUE),
    consumption_heat_pump_k_wh      = sum(consumption_heat_pump_k_wh, na.rm = TRUE),
    consumption_ev_charging_k_wh    = sum(consumption_ev_charging_k_wh, na.rm = TRUE),
    consumption_cooking_lighting_etc_k_wh = sum(consumption_cooking_lighting_etc_k_wh, na.rm = TRUE),
    grid_feed_in_pv_k_wh            = sum(grid_feed_in_pv_k_wh, na.rm = TRUE),
    grid_import_total_k_wh          = sum(grid_import_total_k_wh, na.rm = TRUE),
    self_consumption_pv_k_wh        = sum(self_consumption_pv_k_wh, na.rm = TRUE),

    # Events (any disturbances or spikes during the day)
    is_grid_disturbance             = max(is_grid_disturbance, na.rm = TRUE),
    is_price_spike_response         = max(is_price_spike_response, na.rm = TRUE),

    # Weather (daily averages)
    temperature_daily_C             = mean(`temperature_hourly/°C`, na.rm = TRUE),
    humidity_pct                    = mean(`humidity/%`, na.rm = TRUE),
    wind_speed_ms                   = mean(`wind_speed/m/s`, na.rm = TRUE)
  ) %>%
  ungroup()

```


```{r}
# Save the final merged dataset to a CSV file
readr::write_csv(final_df_d, "final_df_d.csv")
```



```{r}
library(ggplot2)

plot_vars <- c(
  "consumption_base_load_k_wh",
  "consumption_heat_pump_k_wh",
  "consumption_ev_charging_k_wh",
  "consumption_cooking_lighting_etc_k_wh",
  "grid_feed_in_pv_k_wh",
  "grid_import_total_k_wh",
  "self_consumption_pv_k_wh",
  "pv_production_k_wh",
  "temperature_daily/°C",
  "humidity/%",
  "wind_speed/m/s"
)

# Create a named list of plots
plots <- lapply(plot_vars, function(var) {
  ggplot(final_df, aes(x = timestamp, y = .data[[var]])) +
    geom_line() +
    labs(title = var, x = "Timestamp", y = "Value") +
    theme_minimal()
})

# Example: show first plot
plots[[1]]


```
```{r, fig.width = 8, fig.height = 20  }
library(ggplot2)
library(patchwork)

plot_vars <- c(
  "consumption_base_load_k_wh",
  "consumption_heat_pump_k_wh",
  "consumption_ev_charging_k_wh",
  "consumption_cooking_lighting_etc_k_wh",
  "grid_feed_in_pv_k_wh",
  "grid_import_total_k_wh",
  "self_consumption_pv_k_wh",
  "pv_production_k_wh",
  "temperature_hourly/°C",
  "humidity/%",
  "wind_speed/m/s"
)

plots <- lapply(plot_vars, function(var) {
  ggplot(final_df, aes(x = timestamp, y = .data[[var]])) +
    geom_line() +
    labs(title = var, x = "Time", y = "Value") +
    theme_minimal()
})

# Arrange in a grid (adjust ncol as you like)
combined <- wrap_plots(plots, ncol = 1)
combined

# (optional) save
# ggsave("all_timeseries_grid.png", combined, width = 14, height = 12, dpi = 180)

```


# Modeling

TODO: Add modeling steps here.

# Results and Discussion

TODO: Add results and discussion here.

